<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>社区表情包收录工程</title>
    <link rel="stylesheet" href="./assets/style.css" />
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>🤣国内社区表情包收录</h1>
        <p>收录贴吧、知乎、小红书、抖音、B站、微博表情包</p>
        <div class="stats" id="stats">
          <div class="stat-card">
            <div class="stat-number" id="totalEmojis">0</div>
            <div class="stat-label">总表情包</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">6</div>
            <div class="stat-label">平台数量</div>
          </div>
        </div>
      </div>

      <div class="search-container">
        <input
          type="text"
          class="search-input"
          placeholder="搜索表情包..."
          id="searchInput"
        />
      </div>

      <div id="platformsContainer">
        <div class="loading">正在加载表情包数据...</div>
      </div>
    </div>

    <script>
      let emojiData = [];
      let filteredData = [];
      let currentOrder = [];

      const ORDER_STORAGE_KEY = "emoji_platform_order";

      function loadStoredOrder(validNames) {
        try {
          const raw = localStorage.getItem(ORDER_STORAGE_KEY);
          if (!raw) return null;
          const arr = JSON.parse(raw);
          if (!Array.isArray(arr)) return null;
          const validSet = new Set(validNames);
          const filtered = arr.filter((name) => validSet.has(name));
          const missing = validNames.filter((name) => !filtered.includes(name));
          return [...filtered, ...missing];
        } catch (e) {
          return null;
        }
      }

      function saveOrder() {
        try {
          localStorage.setItem(ORDER_STORAGE_KEY, JSON.stringify(currentOrder));
        } catch (e) {}
      }

      // 平台配置
      const platformConfig = {
        贴吧: { icon: "贴", class: "tieba" },
        知乎: { icon: "知", class: "zhihu" },
        小红书: { icon: "红", class: "xiaohongshu" },
        抖音: { icon: "抖", class: "douyin" },
        B站: { icon: "B", class: "bilibili" },
        微博: { icon: "微", class: "weibo" },
      };

      // 加载表情包数据
      async function loadEmojiData() {
        try {
          const response = await fetch("emoji.json");
          emojiData = await response.json();
          filteredData = [...emojiData];
          const names = emojiData.map((p) => p.platform);
          const stored = loadStoredOrder(names);
          currentOrder = stored ?? names.slice();
          applyOrdering();
          renderPlatforms();
          updateStats();
        } catch (error) {
          console.error("加载数据失败:", error);
          document.getElementById("platformsContainer").innerHTML =
            '<div class="loading">❌ 加载失败，请确保 emoji.json 文件存在</div>';
        }
      }

      // 渲染平台
      function renderPlatforms() {
        const container = document.getElementById("platformsContainer");

        if (filteredData.length === 0) {
          container.innerHTML =
            '<div class="loading">😢 没有找到匹配的表情包</div>';
          return;
        }

        container.innerHTML = filteredData
          .map((platform, idx) => {
            const config = platformConfig[platform.platform] || {
              icon: "?",
              class: "default",
            };
            const showMoveUp = idx > 0; // 最顶部的不显示按钮

            return `
                    <div class="platform-section">
                        <div class="platform-header">
                            <div class="platform-title">
                                <div class="platform-icon ${config.class}">${
              config.icon
            }</div>
                                ${platform.platform}
                            </div>
                            <div class="platform-actions">
                                ${
                                  showMoveUp
                                    ? `<button class="pin-button" title="上移一位" onclick="moveUp('${platform.platform}')">上移</button>`
                                    : ""
                                }
                                <div class="platform-count">${
                                  platform.emojis.length
                                } 个表情</div>
                            </div>
                        </div>
                        <div class="emoji-grid">
                            ${platform.emojis
                              .map(
                                (emoji, index) => `
                                <div class="emoji-item" onclick="copyImageToClipboard('${
                                  emoji.url
                                }')">
                                    <img src="${emoji.url}" alt="${
                                  emoji.name || "表情"
                                }" class="emoji-image"
                                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiByeD0iOCIgZmlsbD0iI0Y1RjVGNSIvPgo8dGV4dCB4PSIzMCIgeT0iMzUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyNCIgZmlsbD0iIzk5OTk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+8J+YvjwvdGV4dD4KPHN2Zz4K'">
                                    <div class="emoji-name">${
                                      emoji.name || `表情 ${index + 1}`
                                    }</div>
                                </div>
                            `
                              )
                              .join("")}
                        </div>
                    </div>
                `;
          })
          .join("");
      }

      // 更新统计信息
      function updateStats() {
        const totalEmojis = filteredData.reduce(
          (sum, platform) => sum + platform.emojis.length,
          0
        );
        document.getElementById("totalEmojis").textContent = totalEmojis;
      }

      // 按自定义顺序排序
      function applyOrdering() {
        const orderIndex = new Map(currentOrder.map((n, i) => [n, i]));
        filteredData.sort(
          (a, b) =>
            (orderIndex.get(a.platform) ?? 0) -
            (orderIndex.get(b.platform) ?? 0)
        );
      }

      // 搜索功能
      function filterEmojis(searchTerm) {
        if (!searchTerm.trim()) {
          filteredData = [...emojiData];
        } else {
          filteredData = emojiData
            .map((platform) => ({
              ...platform,
              emojis: platform.emojis.filter(
                (emoji) =>
                  (emoji.name || "")
                    .toLowerCase()
                    .includes(searchTerm.toLowerCase()) ||
                  platform.platform
                    .toLowerCase()
                    .includes(searchTerm.toLowerCase())
              ),
            }))
            .filter((platform) => platform.emojis.length > 0);
        }

        applyOrdering();
        renderPlatforms();
        updateStats();
      }

      function moveUp(name) {
        const idx = currentOrder.indexOf(name);
        if (idx > 0) {
          const tmp = currentOrder[idx - 1];
          currentOrder[idx - 1] = currentOrder[idx];
          currentOrder[idx] = tmp;
          saveOrder();
          applyOrdering();
          renderPlatforms();
          updateStats();
        }
      }

      // 复制图片到剪贴板
      async function copyImageToClipboard(imageSrc) {
        try {
          // 创建一个临时的 canvas 来处理图片
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          const img = new Image();

          // 设置跨域属性
          img.crossOrigin = "anonymous";

          return new Promise((resolve, reject) => {
            img.onload = async () => {
              try {
                // 设置 canvas 尺寸
                canvas.width = img.width;
                canvas.height = img.height;

                // 绘制图片到 canvas
                ctx.drawImage(img, 0, 0);

                // 将 canvas 转换为 blob
                canvas.toBlob(async (blob) => {
                  try {
                    // 使用 Clipboard API 复制图片
                    await navigator.clipboard.write([
                      new ClipboardItem({
                        [blob.type]: blob,
                      }),
                    ]);

                    showToast("✅ 图片已复制到剪贴板！", "#4CAF50");
                    resolve();
                  } catch (err) {
                    // 如果复制图片失败，回退到复制路径
                    console.warn("复制图片失败，回退到复制路径:", err);
                    await fallbackCopyText(imageSrc);
                    resolve();
                  }
                }, "image/png");
              } catch (err) {
                console.error("处理图片失败:", err);
                await fallbackCopyText(imageSrc);
                resolve();
              }
            };

            img.onerror = async () => {
              console.error("加载图片失败:", imageSrc);
              await fallbackCopyText(imageSrc);
              resolve();
            };

            // 开始加载图片
            img.src = imageSrc;
          });
        } catch (err) {
          console.error("复制功能不支持:", err);
          await fallbackCopyText(imageSrc);
        }
      }

      // 回退方案：复制文本路径
      async function fallbackCopyText(text) {
        try {
          await navigator.clipboard.writeText(text);
          showToast("📋 图片路径已复制到剪贴板", "#FF9800");
        } catch (err) {
          console.error("复制路径也失败了:", err);
          showToast("❌ 复制失败，请手动保存图片", "#f44336");
        }
      }

      // 显示提示消息
      function showToast(message, backgroundColor = "#4CAF50") {
        const toast = document.createElement("div");
        toast.textContent = message;
        toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${backgroundColor};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 1000;
                font-size: 14px;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: fadeInOut 3s ease-in-out;
            `;
        document.body.appendChild(toast);
        setTimeout(() => {
          if (document.body.contains(toast)) {
            document.body.removeChild(toast);
          }
        }, 3000);
      }

      // 事件监听
      document.getElementById("searchInput").addEventListener("input", (e) => {
        filterEmojis(e.target.value);
      });

      // 初始化
      loadEmojiData();
    </script>
  </body>
</html>
