<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è¡¨æƒ…åŒ…æ ‡ç­¾ç³»ç»Ÿ V4 (åŒè½´ç‰ˆ)</title>
    <link rel="stylesheet" href="assets/config-style.css" />
  </head>
  <body>
    <div class="container">
      <h1>è¡¨æƒ…åŒ…åœ¨çº¿å‘½å & æ‰“æ ‡ç­¾å·¥å…· (V4)</h1>

      <div class="instructions">
        <h2>åŒè½´æ ‡ç­¾ä½“ç³»è¯´æ˜</h2>
        <p>
          <strong>æƒ…æ„Ÿè½´</strong>ï¼šè¡¨æƒ…ä¼ é€’çš„æ ¸å¿ƒæƒ…ç»ªè‰²å½© -
          positive(ç§¯æ)ã€negative(æ¶ˆæ)ã€neutral(ä¸­æ€§)
        </p>
        <p>
          <strong>æ–‡æ¡ˆé£æ ¼è½´</strong>ï¼šè¡¨æƒ…çš„æ–‡æ¡ˆè¡¨è¾¾é£æ ¼ -
          supportive(é¼“åŠ±å®‰æ…°)ã€sarcastic(é˜´é˜³æ€ªæ°”)ã€humorous(å¹½é»˜)ã€surreal(æŠ½è±¡)ã€playful(ä¿çš®)ã€plain(é€šç”¨)
        </p>
        <p style="color: #718096; font-size: 14px">
          ğŸ’¡ æ¯ä¸ªè½´éƒ½å¯ä»¥å¤šé€‰ï¼Œä¸€ä¸ªè¡¨æƒ…å¯ä»¥åŒæ—¶å…·æœ‰å¤šç§æƒ…æ„Ÿè‰²å½©å’Œæ–‡æ¡ˆé£æ ¼
        </p>
      </div>

      <div class="cache-info" id="cache-info">ğŸ’¾ åŠ è½½ç¼“å­˜çŠ¶æ€ä¸­...</div>
      <div class="cache-actions">
        <button id="load-from-json-btn">ä»JSONé‡æ–°åŠ è½½</button>
        <button id="clear-cache-btn" class="clear-cache-btn">
          æ¸…é™¤æ‰€æœ‰ç¼“å­˜
        </button>
      </div>

      <div id="tagging-root"></div>

      <div id="output-area">
        <h2><strong>æœ€åä¸€æ­¥</strong>ï¼šç”Ÿæˆå¹¶ä¸‹è½½å¸¦æœ‰æ ‡ç­¾çš„JSON</h2>
        <button id="generate-btn">ç”Ÿæˆå¹¶ä¸‹è½½ tagged_emoji.json</button>
        <p style="margin-top: 1rem">æœ€ç»ˆç”Ÿæˆçš„JSONé¢„è§ˆï¼š</p>
        <textarea id="output-json" readonly></textarea>
      </div>
    </div>

    <script>
      // --- 1. å®šä¹‰æ‰€éœ€å˜é‡å’Œé¢„è®¾æ ‡ç­¾ ---
      const taggingRoot = document.getElementById("tagging-root");
      const generateBtn = document.getElementById("generate-btn");
      const outputJsonTextarea = document.getElementById("output-json");

      const tagCategories = {
        sentiment: {
          title: "æƒ…æ„Ÿè½´",
          description: "è¡¨æƒ…ä¼ é€’çš„æ ¸å¿ƒæƒ…ç»ªè‰²å½©",
          tags: [
            { value: "positive", label: "ç§¯æ" },
            { value: "negative", label: "æ¶ˆæ" },
            { value: "neutral", label: "ä¸­æ€§" },
          ],
        },
        style: {
          title: "æ–‡æ¡ˆé£æ ¼è½´",
          description: "è¡¨æƒ…çš„æ–‡æ¡ˆè¡¨è¾¾é£æ ¼",
          tags: [
            { value: "supportive", label: "é¼“åŠ±å®‰æ…°" },
            { value: "sarcastic", label: "é˜´é˜³æ€ªæ°”" },
            { value: "humorous", label: "å¹½é»˜" },
            { value: "surreal", label: "æŠ½è±¡" },
            { value: "playful", label: "ä¿çš®" },
            { value: "plain", label: "é€šç”¨" },
          ],
        },
      };

      let emojiData = [];

      // --- ç¼“å­˜ç®¡ç†å‡½æ•° ---
      const CACHE_KEY = "emoji_config_cache";

      function saveToCache() {
        try {
          localStorage.setItem(CACHE_KEY, JSON.stringify(emojiData));
          updateCacheStatus();
        } catch (error) {
          console.error("ä¿å­˜ç¼“å­˜å¤±è´¥:", error);
        }
      }

      function loadFromCache() {
        try {
          const cached = localStorage.getItem(CACHE_KEY);
          return cached ? JSON.parse(cached) : null;
        } catch (error) {
          console.error("åŠ è½½ç¼“å­˜å¤±è´¥:", error);
          return null;
        }
      }

      function clearCache() {
        localStorage.removeItem(CACHE_KEY);
        updateCacheStatus();
      }

      function updateCacheStatus() {
        const cacheInfo = document.getElementById("cache-info");
        const cached = loadFromCache();
        if (cached && cacheInfo) {
          let totalEmojis = 0;
          let taggedEmojis = 0;
          cached.forEach((platform) => {
            platform.emojis.forEach((emoji) => {
              totalEmojis++;
              if (emoji.name || emoji.tags.length > 0 || (emoji.keywords && emoji.keywords.length > 0)) {
                taggedEmojis++;
              }
            });
          });
          cacheInfo.textContent = `ğŸ’¾ å·²ç¼“å­˜è¿›åº¦ï¼š${taggedEmojis}/${totalEmojis} ä¸ªè¡¨æƒ…å·²æ ‡æ³¨`;
        } else if (cacheInfo) {
          cacheInfo.textContent = "ğŸ’¾ æš‚æ— ç¼“å­˜æ•°æ®";
        }
      }

      // --- 2. é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–å’Œæ¸²æŸ“æ•°æ® ---
      document.addEventListener("DOMContentLoaded", async () => {
        try {
          // ä¼˜å…ˆä»ç¼“å­˜åŠ è½½æ•°æ®
          const cachedData = loadFromCache();

          if (cachedData) {
            emojiData = cachedData;
            renderTaggerUI();
            updateCacheStatus();
            console.log("ä»ç¼“å­˜åŠ è½½æ•°æ®æˆåŠŸ");
          } else {
            // ç¼“å­˜æ— æ•°æ®æ—¶ä»jsonæ–‡ä»¶åŠ è½½
            const response = await fetch("emoji.json");
            if (!response.ok) {
              throw new Error(
                `HTTP error! status: ${response.status}. è¯·ç¡®ä¿ emoji.json æ–‡ä»¶ä¸æ­¤htmlåœ¨åŒä¸€ç›®å½•ä¸‹ï¼Œå¹¶ä¸”æ‚¨æ­£åœ¨ä½¿ç”¨æœ¬åœ°æœåŠ¡å™¨è®¿é—®ã€‚`
              );
            }
            emojiData = await response.json();
            renderTaggerUI();
            updateCacheStatus();
            console.log("ä»JSONæ–‡ä»¶åŠ è½½æ•°æ®æˆåŠŸ");
          }
        } catch (err) {
          taggingRoot.innerHTML = `<p style="color: red;"><strong>åŠ è½½å¤±è´¥ï¼š</strong>${err.message}</p>`;
          console.error(err);
        }
      });

      // --- 3. æ¸²æŸ“UIç•Œé¢çš„å‡½æ•° (ä¸ä¹‹å‰ç‰ˆæœ¬ç›¸åŒ) ---
      function renderTaggerUI() {
        emojiData.forEach((platformData, platformIndex) => {
          const section = document.createElement("div");
          section.className = "platform-section";

          const title = document.createElement("h2");
          title.textContent = `å¹³å°ï¼š${platformData.platform}`;
          section.appendChild(title);

          const grid = document.createElement("div");
          grid.className = "emoji-grid";

          platformData.emojis.forEach((emoji, emojiIndex) => {
            const card = document.createElement("div");
            card.className = "emoji-card";
            const preview = document.createElement("div");
            preview.className = "emoji-preview";
            const img = document.createElement("img");
            img.src = emoji.url;
            img.alt = emoji.name || emoji.description || emoji.url;

            const descContainer = document.createElement("div");
            descContainer.className = "desc-container";
            const descLabel = document.createElement("label");
            descLabel.textContent = "åç§°";
            descLabel.className = "desc-label";
            const descInput = document.createElement("input");
            descInput.type = "text";
            descInput.value = emoji.name || emoji.description || "";
            descInput.className = "desc-input";
            descInput.oninput = (e) => {
              // ç»Ÿä¸€ä½¿ç”¨nameå­—æ®µï¼Œç§»é™¤descriptionå­—æ®µ
              emojiData[platformIndex].emojis[emojiIndex].name = e.target.value;
              // å¦‚æœå­˜åœ¨descriptionå­—æ®µï¼Œåˆ é™¤å®ƒ
              if (
                emojiData[platformIndex].emojis[emojiIndex].hasOwnProperty(
                  "description"
                )
              ) {
                delete emojiData[platformIndex].emojis[emojiIndex].description;
              }
              updateJsonPreview();
              saveToCache();
            };
            descContainer.appendChild(descLabel);
            descContainer.appendChild(descInput);

            preview.appendChild(img);
            preview.appendChild(descContainer);

            // Keywordsç¼–è¾‘åŒºåŸŸ (ç‹¬ç«‹çš„cardçº§åˆ«ç»„ä»¶)
            const keywordsContainer = document.createElement("div");
            keywordsContainer.className = "keywords-container";
            const keywordsLabel = document.createElement("label");
            keywordsLabel.textContent = "å…³é”®è¯ (Keywords)";
            keywordsLabel.className = "keywords-label";
            keywordsContainer.appendChild(keywordsLabel);

            const keywordsInput = document.createElement("input");
            keywordsInput.type = "text";
            keywordsInput.placeholder = "è¾“å…¥å…³é”®è¯ï¼Œç”¨è‹±æ–‡é€—å·åˆ†éš”";
            keywordsInput.className = "keywords-input";

            // åˆå§‹åŒ–keywordsæ•°ç»„
            if (!emoji.keywords) {
              emojiData[platformIndex].emojis[emojiIndex].keywords = [];
            }

            // æ˜¾ç¤ºç°æœ‰keywords (æ•°ç»„è½¬æ¢ä¸ºé€—å·åˆ†éš”å­—ç¬¦ä¸²)
            const keywordsArray = emojiData[platformIndex].emojis[emojiIndex].keywords || [];
            keywordsInput.value = keywordsArray.join(',');

            // è¾“å…¥å˜åŒ–æ—¶æ›´æ–°æ•°æ®
            keywordsInput.oninput = (e) => {
              const keywordsText = e.target.value;
              // è§£æé€—å·åˆ†éš”å­—ç¬¦ä¸²ä¸ºæ•°ç»„ï¼Œå»é™¤ç©ºç™½å’Œé‡å¤
              const keywords = keywordsText
                .split(',')
                .map(k => k.trim())
                .filter((k, index, arr) => k && arr.indexOf(k) === index);
              
              emojiData[platformIndex].emojis[emojiIndex].keywords = keywords;
              updateJsonPreview();
              saveToCache();
            };

            keywordsContainer.appendChild(keywordsInput);

            const tagsGroup = document.createElement("div");
            tagsGroup.className = "form-group";
            const tagsLabel = document.createElement("label");
            tagsLabel.textContent = "æ ‡ç­¾åˆ†ç±» (Tag Categories)";
            tagsGroup.appendChild(tagsLabel);

            Object.entries(tagCategories).forEach(([categoryKey, category]) => {
              const categoryDiv = document.createElement("div");
              categoryDiv.className = "tag-category";

              const categoryHeader = document.createElement("div");
              categoryHeader.className = "tag-category-header";

              const categoryTitle = document.createElement("div");
              categoryTitle.className = "tag-category-title";
              categoryTitle.textContent = category.title;

              const categoryDesc = document.createElement("div");
              categoryDesc.className = "tag-category-desc";
              categoryDesc.textContent = category.description;

              categoryHeader.appendChild(categoryTitle);
              categoryHeader.appendChild(categoryDesc);

              const tagsContainer = document.createElement("div");
              tagsContainer.className = "tag-group";

              category.tags.forEach((tag) => {
                const label = document.createElement("label");
                const checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.value = tag.value;
                if (emoji.tags.includes(tag.value)) {
                  checkbox.checked = true;
                }
                checkbox.onchange = (e) => {
                  const currentTags = new Set(
                    emojiData[platformIndex].emojis[emojiIndex].tags
                  );
                  if (e.target.checked) {
                    currentTags.add(tag.value);
                  } else {
                    currentTags.delete(tag.value);
                  }
                  emojiData[platformIndex].emojis[emojiIndex].tags =
                    Array.from(currentTags);
                  updateJsonPreview();
                  saveToCache();
                };
                label.appendChild(checkbox);
                label.append(tag.label);
                tagsContainer.appendChild(label);
              });

              categoryDiv.appendChild(categoryHeader);
              categoryDiv.appendChild(tagsContainer);
              tagsGroup.appendChild(categoryDiv);
            });

            card.appendChild(preview);
            card.appendChild(keywordsContainer);
            card.appendChild(tagsGroup);
            grid.appendChild(card);
          });

          section.appendChild(grid);
          taggingRoot.appendChild(section);
        });

        updateJsonPreview();
      }

      // --- 4. æ›´æ–°é¢„è§ˆå’Œç”Ÿæˆä¸‹è½½ (ä¸ä¹‹å‰ç‰ˆæœ¬ç›¸åŒ) ---
      function updateJsonPreview() {
        outputJsonTextarea.value = JSON.stringify(emojiData, null, 2);
      }

      generateBtn.addEventListener("click", () => {
        if (emojiData.length === 0) {
          alert("æ•°æ®æœªåŠ è½½ï¼Œæ— æ³•ç”Ÿæˆï¼");
          return;
        }
        const jsonString = JSON.stringify(emojiData, null, 2);
        const blob = new Blob([jsonString], { type: "application/json" });
        const url = URL.createObjectURL(blob);

        const link = document.createElement("a");
        link.href = url;
        link.download = "tagged_emoji.json";

        document.body.appendChild(link);
        link.click();

        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      });

      // --- ç¼“å­˜ç®¡ç†æŒ‰é’®äº‹ä»¶ ---
      document
        .getElementById("load-from-json-btn")
        .addEventListener("click", async () => {
          if (
            confirm("ç¡®å®šè¦ä»JSONæ–‡ä»¶é‡æ–°åŠ è½½æ•°æ®å—ï¼Ÿè¿™å°†è¦†ç›–å½“å‰çš„ç¼“å­˜æ•°æ®ã€‚")
          ) {
            try {
              const response = await fetch("emoji.json");
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              emojiData = await response.json();
              saveToCache();
              taggingRoot.innerHTML = "";
              renderTaggerUI();
              updateCacheStatus();
            } catch (error) {
              alert("åŠ è½½å¤±è´¥ï¼š" + error.message);
            }
          }
        });

      document
        .getElementById("clear-cache-btn")
        .addEventListener("click", () => {
          if (
            confirm(
              "ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ç¼“å­˜æ•°æ®å—ï¼Ÿè¿™å°†ä¸ä¼šå½±å“JSONæ–‡ä»¶ï¼Œä½†ä¼šä¸¢å¤±æœªä¿å­˜çš„æ ‡æ³¨è¿›åº¦ã€‚"
            )
          ) {
            clearCache();
          }
        });
    </script>
  </body>
</html>
